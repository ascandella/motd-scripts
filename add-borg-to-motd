#!/bin/bash

set -e

source /root/.borg

THISDIR="$(dirname "$(readlink -f "$0")")"

set +e
BORG_OUTPUT="$(borg list --prefix "$(hostname)" $REPOSITORY | tail -n 3)"
SALL_GOOD=$?
set -e

RESET="\e[0m"
HEADER_COLOR="\e[48;5;237m"

header() {
  echo -e "${HEADER_COLOR}${1}${RESET}"
}

if [[ $SALL_GOOD -eq 0 ]] ; then
  header "Latest Backups"
  echo "${BORG_OUTPUT}"
else
  echo -ne "\e[41m"
  echo "Unable to query backups"
  exit "${SALL_GOOD}"
fi

BORG_OUT="/tmp/borg.latest"
EXTRACT="${THISDIR}/borg-extract"
if [[ -r "${BORG_OUT}" ]] ; then
  echo -ne "${HEADER_COLOR}"
  "${EXTRACT}" "${BORG_OUT}"
  echo -ne "${RESET}"
fi
