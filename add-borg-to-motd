#!/bin/bash

set -e

source /root/.borg

THISDIR="$(dirname "$(readlink -f "$0")")"

set +e
BORG_OUTPUT="$(borg list --prefix "$(hostname)" $REPOSITORY | tail -n 3)"
SALL_GOOD=$?
set -e

RESET="\e[0m"

if [[ $SALL_GOOD -eq 0 ]] ; then
  echo "Latest backups:"
  echo -ne "\e[94m"
  echo -e "${BORG_OUTPUT}${RESET}"
else
  echo -ne "\e[41m"
  echo "Unable to query backups"
  exit "${SALL_GOOD}"
fi

BORG_OUT="/tmp/borg.latest"
EXTRACT="${THISDIR}/borg-extract"
if [[ -r "${BORG_OUT}" ]] ; then
  echo -ne "\e[48;5;244m"
  "${EXTRACT}" "${BORG_OUT}"
  echo -e "${RESET}"
fi
