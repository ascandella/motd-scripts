#!/bin/bash
# note: not to be run directly, shebang just for shellcheck
# vim: filetype=sh

THISDIR="$(dirname "$(readlink -f "$0")")"
export THISDIR

# Paths
export BORG_OUT='/tmp/borg.latest'
export EXTRACT="${THISDIR}/borg-extract"
export BORG="borg"

# Secret keys
BORG_KEYS='/root/.borg'
# shellcheck source=/dev/null
source "${BORG_KEYS}"


# Variables
USER="$(whoami)"
export USER
HOSTNAME="$(uname -n)"
export HOSTNAME

# Colors
export HEADER_COLOR="\e[48;5;237m"
export COLOR_COLUMN="\e[1m-"
export COLOR_YELLOW="\e[93m"
export COLOR_GREEN="\e[92m"
export COLOR_BLUE="\e[36m"  # actually cyan
export COLOR_RED="\e[41m"

# Styles
export STYLE_BOLD="\e[1m"

# Backgrounds
export BACKGROUND_NICE_BLUE="\e[48;5;31m"

# Resets
export RESET_TEXT="\e[0m"
export STYLE_NORMAL="\e[49m"

# Layout
export FIRST_COLUMN=30

# Backup configuration
export NUM_BACKUPS=3

# shellcheck source=./common
source "${BORG_KEYS}"

USER="$(whoami)"
HOSTNAME="$(uname -n)"

# somehowe, we can may this dynamic in the future.
export TARGET_WIDTH=30

display_column1() {
  printf " ${COLOR_COLUMN}- %-$((FIRST_COLUMN - 5))s${RESET_TEXT}" "${1}"
  echo -ne " ${RESET_TEXT}"
}

display_column2() {
  local readonly trimmed="$(echo "${1}" | sed 's/\s\+/ /g')"
  printf "${COLOR_BLUE} %15s ${trimmed}${RESET_TEXT}\n"
}

function break_columns() {
  while read -r line ; do
    while read -ra columns ; do
      local columnParts=()
      columnParts+=("${line}")

      for part in "${columnParts[@]}" ; do
        first="$(echo "${line}" | cut -d' ' -f1)"
        local col1_width="$(echo "${first}" | wc -c)"
        rest="$(echo "${line}" | tr -s ' ' | cut -d' ' -f2)"
        local col2_width="$(echo "${rest}" | wc -c)"
        padding=$((TARGET_WIDTH - col1_width - col2_width))
        printf "%-${FIRST_COLUMN}s" "${first}"
        printf "%-${padding}s" " "
        echo -e "${rest}"
      done
      echo
    done <<< "${1}"
  done
}

header_1() {
  set +x
  display_column1 "${1}"
  #$1="$(sed 's/-- [\W]+ //')"
  #shift
  #if [[ -n "${1:-}" ]] ; then
    #break_columns $@
  #fi
}

say_color() {
  printf "%b%b%b\n" "${1}" "${2}" "${RESET_TEXT}"
}

header() {
  say_color "${HEADER_COLOR}" "${1}"
}

reset_color() {
  echo -ne "${RESET_TEXT}"
}

has_delim() {
  if [[ "${1}" =~ [$2] ]] ; then
    return 0
  fi
  return 1
}

trim_whitespace() {
  echo -e "${1}" | tr -d '[:space:]'
}

greater_than() {
  if [ "${2}" -gt "${1}" ]; then
    echo "${1}"
  fi
  echo "${1}"
}
